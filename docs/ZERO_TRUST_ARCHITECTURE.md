# Zero Trust ç½‘ç»œæ¶æ„æ–¹æ¡ˆ
# Zero Trust Network Architecture

> æœ¬æ–‡æ¡£è¯´æ˜ AnixOps é¡¹ç›®ä¸­ Cloudflared å’Œ WARP Connector çš„ä½¿ç”¨åœºæ™¯å’Œæ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•

- [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
- [ç»„ä»¶è¯´æ˜](#ç»„ä»¶è¯´æ˜)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

AnixOps é¡¹ç›®é‡‡ç”¨ **åŒè½¨åˆ¶ Zero Trust ç½‘ç»œæ¶æ„**ï¼Œé€šè¿‡ Cloudflare çš„ä¸¤ä¸ªæ ¸å¿ƒäº§å“å®ç°ä¸åŒçš„ç½‘ç»œéœ€æ±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Cloudflare Zero Trust                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Cloudflared Tunnel â”‚         â”‚   WARP Connector    â”‚      â”‚
â”‚  â”‚   (å…¥ç«™æµé‡/Inbound) â”‚         â”‚ (å†…ç½‘äº’è”/Internal)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â†“                                â†“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“                                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å…¬ç½‘è®¿é—®      â”‚                â”‚  æœåŠ¡å™¨å†…ç½‘   â”‚
    â”‚  Public Web   â”‚                â”‚  Private Net â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ ç»„ä»¶è¯´æ˜

### 1. Cloudflared Tunnelï¼ˆå…¥ç«™ä»£ç†ï¼‰

**ç”¨é€”ï¼š** å°† K8s é›†ç¾¤å†…çš„ HTTP/HTTPS æœåŠ¡å®‰å…¨åœ°æš´éœ²åˆ°å…¬ç½‘

**ç‰¹ç‚¹ï¼š**
- âœ… æ— éœ€å¼€æ”¾å…¥ç«™ç«¯å£ï¼ˆNo inbound portsï¼‰
- âœ… è‡ªåŠ¨ HTTPS/TLS ç»ˆæ­¢
- âœ… DDoS é˜²æŠ¤
- âœ… è®¿é—®æ§åˆ¶å’Œèº«ä»½éªŒè¯
- âœ… å…¨çƒ CDN åŠ é€Ÿ

**é€‚ç”¨åœºæ™¯ï¼š**
- Web åº”ç”¨å’Œç½‘ç«™
- RESTful API æœåŠ¡
- Webhook æ¥æ”¶ç«¯ç‚¹
- éœ€è¦å…¬ç½‘è®¿é—®çš„ä»»ä½• HTTP(S) æœåŠ¡

**éƒ¨ç½²ä½ç½®ï¼š**
```yaml
K8s Pod Sidecar æ¨¡å¼
â”œâ”€â”€ ä¸»å®¹å™¨ï¼ˆApplication Containerï¼‰
â”‚   â””â”€â”€ ä½ çš„åº”ç”¨æœåŠ¡ï¼ˆå¦‚ nginx, API serverï¼‰
â””â”€â”€ Sidecar å®¹å™¨ï¼ˆCloudflared Containerï¼‰
    â””â”€â”€ cloudflared tunnel run
```

**é…ç½®ç¤ºä¾‹ï¼š**
```yaml
# k8s_manifests/api-with-cloudflared-sidecar/deployment.yaml
containers:
  - name: api-service
    image: your-api:latest
    ports:
      - containerPort: 8080
  
  - name: cloudflared
    image: cloudflare/cloudflared:latest
    args:
      - tunnel
      - --no-autoupdate
      - run
      - --token
      - $(TUNNEL_TOKEN)
    env:
      - name: TUNNEL_TOKEN
        valueFrom:
          secretKeyRef:
            name: cloudflared-secret
            key: TUNNEL_TOKEN
```

---

### 2. WARP Connectorï¼ˆå†…ç½‘äº’è”ï¼‰

**ç”¨é€”ï¼š** åœ¨ Cloudflare çš„ Zero Trust ç½‘ç»œä¸­å»ºç«‹æœåŠ¡å™¨é—´çš„åŒå‘å®‰å…¨è¿æ¥

**ç‰¹ç‚¹ï¼š**
- âœ… æœåŠ¡å™¨ä¹‹é—´çš„ç›´æ¥é€šä¿¡ï¼ˆæ— éœ€å…¬ç½‘æš´éœ²ï¼‰
- âœ… åŸºäº WireGuard çš„åŠ å¯†éš§é“
- âœ… é›¶ä¿¡ä»»è®¿é—®æ§åˆ¶
- âœ… åŒå‘é€šä¿¡ï¼ˆBidirectionalï¼‰
- âœ… æ”¯æŒæ‰€æœ‰åè®®ï¼ˆTCP/UDP/ICMPï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- æ•°æ®åº“è®¿é—®ï¼ˆMySQL, PostgreSQL, Redisï¼‰
- SSH è¿œç¨‹ç®¡ç†
- æœåŠ¡å™¨é—´ RPC è°ƒç”¨
- å†…éƒ¨ API è°ƒç”¨
- ç›‘æ§å’Œæ—¥å¿—é‡‡é›†ï¼ˆPrometheus, Lokiï¼‰
- Kubernetes èŠ‚ç‚¹é—´é€šä¿¡

**éƒ¨ç½²ä½ç½®ï¼š**
```yaml
K8s DaemonSet æˆ– Deployment
â””â”€â”€ WARP Connector Container
    â””â”€â”€ cloudflared warp-routing
```

**ç½‘ç»œæ¨¡å‹ï¼š**
```
æœåŠ¡å™¨ A (pl-1)          Cloudflare WARP          æœåŠ¡å™¨ B (de-1)
â”œâ”€â”€ K8s Cluster         â†â†’ Zero Trust Network â†â†’   â”œâ”€â”€ K8s Cluster
â”‚   â””â”€â”€ WARP Connector                              â”‚   â””â”€â”€ WARP Connector
â”‚                                                   â”‚
â””â”€â”€ Internal Services                               â””â”€â”€ Internal Services
    â”œâ”€â”€ Database                                        â”œâ”€â”€ Database
    â”œâ”€â”€ Redis                                           â”œâ”€â”€ Prometheus
    â””â”€â”€ Internal APIs                                   â””â”€â”€ Grafana
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | Cloudflared Tunnel | WARP Connector | è¯´æ˜ |
|-----|-------------------|----------------|-----|
| **Web åº”ç”¨æš´éœ²** | âœ… æ¨è | âŒ ä¸é€‚ç”¨ | éœ€è¦å…¬ç½‘è®¿é—®çš„ Web åº”ç”¨ |
| **API æœåŠ¡æš´éœ²** | âœ… æ¨è | âŒ ä¸é€‚ç”¨ | RESTful APIã€GraphQL ç­‰ |
| **æ•°æ®åº“è¿æ¥** | âŒ ä¸æ¨è | âœ… æ¨è | æœåŠ¡å™¨é—´æ•°æ®åº“è®¿é—® |
| **SSH ç®¡ç†** | âš ï¸ å¯ç”¨* | âœ… æ¨è | *éœ€è¦é…ç½® SSH over HTTP |
| **Prometheus é‡‡é›†** | âŒ ä¸é€‚ç”¨ | âœ… æ¨è | ç›‘æ§æ•°æ®é‡‡é›† |
| **æœåŠ¡é—´ RPC** | âŒ ä¸é€‚ç”¨ | âœ… æ¨è | gRPCã€Thrift ç­‰ |
| **æ–‡ä»¶ä¼ è¾“** | âš ï¸ å¯ç”¨ | âœ… æ¨è | SFTPã€rsync ç­‰ |
| **Webhook æ¥æ”¶** | âœ… æ¨è | âŒ ä¸é€‚ç”¨ | GitHubã€GitLab webhooks |

---

## ğŸš€ éƒ¨ç½²ç­–ç•¥

### åœºæ™¯ 1ï¼šå•ä¸ª Web åº”ç”¨ + API

```yaml
éƒ¨ç½²æ–¹æ¡ˆï¼š
â”œâ”€â”€ Cloudflared Tunnel (Sidecar)
â”‚   â””â”€â”€ ç”¨äºæš´éœ² API åˆ°å…¬ç½‘
â””â”€â”€ WARP Connector (DaemonSet)
    â””â”€â”€ ç”¨äºè®¿é—®åç«¯æ•°æ®åº“å’Œ Redis
```

**Playbookï¼š**
```bash
# 1. éƒ¨ç½²åº”ç”¨ï¼ˆåŒ…å« Cloudflared Sidecarï¼‰
bash anixops.sh deploy-app-remote -g nginx_test

# 2. éƒ¨ç½² WARP Connectorï¼ˆå»ºç«‹å†…ç½‘è¿æ¥ï¼‰
bash anixops.sh deploy-warp -g nginx_test
```

---

### åœºæ™¯ 2ï¼šå¾®æœåŠ¡æ¶æ„

```yaml
éƒ¨ç½²æ–¹æ¡ˆï¼š
â”œâ”€â”€ å‰ç«¯æœåŠ¡
â”‚   â””â”€â”€ Cloudflared Tunnel (Sidecar)
â”‚       â””â”€â”€ æš´éœ²å‰ç«¯åº”ç”¨åˆ°å…¬ç½‘
â”œâ”€â”€ API ç½‘å…³
â”‚   â””â”€â”€ Cloudflared Tunnel (Sidecar)
â”‚       â””â”€â”€ æš´éœ² API åˆ°å…¬ç½‘
â”œâ”€â”€ å†…éƒ¨æœåŠ¡ (æ—  Cloudflared)
â”‚   â”œâ”€â”€ User Service
â”‚   â”œâ”€â”€ Order Service
â”‚   â””â”€â”€ Payment Service
â””â”€â”€ WARP Connector (DaemonSet)
    â””â”€â”€ ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡é—´é€šä¿¡
```

---

### åœºæ™¯ 3ï¼šå¤šé›†ç¾¤ç›‘æ§ï¼ˆPLG Stackï¼‰

```yaml
æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Monitoring Cluster (pl-1)                                  â”‚
â”‚  â”œâ”€â”€ Grafana (Cloudflared Tunnel) â† å…¬ç½‘è®¿é—® Dashboard      â”‚
â”‚  â”œâ”€â”€ Prometheus                                             â”‚
â”‚  â”œâ”€â”€ Loki                                                   â”‚
â”‚  â””â”€â”€ WARP Connector â† é€šè¿‡ WARP é‡‡é›†å…¶ä»–æœåŠ¡å™¨æŒ‡æ ‡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘ WARP Network â†‘
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Cluster 1   â”‚    â”‚ App Cluster 2    â”‚   â”‚ Servers   â”‚
â”‚ â””â”€â”€ WARP        â”‚    â”‚ â””â”€â”€ WARP         â”‚   â”‚ â””â”€â”€ WARP  â”‚
â”‚ â””â”€â”€ Node Exp.   â”‚    â”‚ â””â”€â”€ Promtail     â”‚   â”‚ â””â”€â”€ Exporterâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Playbookï¼š**
```bash
# 1. éƒ¨ç½²ç›‘æ§é›†ç¾¤ï¼ˆpl-1ï¼‰
ansible-playbook playbooks/deployment/deploy_monitoring.yml

# 2. åœ¨æ‰€æœ‰æœåŠ¡å™¨éƒ¨ç½² WARP Connectorï¼ˆå®¿ä¸»æœºæ–¹å¼ï¼‰
ansible-playbook playbooks/deployment/deploy_warp_host.yml -e "warp_token=YOUR_TOKEN"

# æ³¨: ä½¿ç”¨ ansible.cfg ä¸­é…ç½®çš„é»˜è®¤ inventory (inventory/hosts.yml)
```

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. å®‰å…¨ç­–ç•¥

**Cloudflared Tunnelï¼š**
- âœ… ä½¿ç”¨ Cloudflare Access è¿›è¡Œèº«ä»½éªŒè¯
- âœ… å¯ç”¨ WAF è§„åˆ™ä¿æŠ¤åº”ç”¨
- âœ… é™åˆ¶ IP ç™½åå•ï¼ˆå¦‚éœ€è¦ï¼‰
- âœ… å®šæœŸè½®æ¢ Tunnel Token

**WARP Connectorï¼š**
- âœ… ä½¿ç”¨ Zero Trust Gateway ç­–ç•¥æ§åˆ¶è®¿é—®
- âœ… å¯ç”¨è®¾å¤‡æ€åŠ¿æ£€æŸ¥ï¼ˆDevice Postureï¼‰
- âœ… é…ç½®ç½‘ç»œéš”ç¦»ç­–ç•¥
- âœ… å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—

---

### 2. æ€§èƒ½ä¼˜åŒ–

**Cloudflaredï¼š**
```yaml
# å»ºè®®é…ç½®
resources:
  requests:
    memory: "64Mi"
    cpu: "100m"
  limits:
    memory: "128Mi"
    cpu: "200m"

# å¤šå‰¯æœ¬æé«˜å¯ç”¨æ€§
replicas: 2
```

**WARP Connectorï¼š**
```yaml
# DaemonSet æ¨¡å¼ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªï¼‰
kind: DaemonSet
# æˆ–è€… Deployment æ¨¡å¼ï¼ˆé›†ä¸­å¼ï¼‰
kind: Deployment
replicas: 1  # é€šå¸¸ä¸€ä¸ªè¶³å¤Ÿ
```

---

### 3. æ•…éšœæ’é™¤

**Cloudflared è¿æ¥é—®é¢˜ï¼š**
```bash
# æŸ¥çœ‹ cloudflared æ—¥å¿—
kubectl logs -n <namespace> <pod-name> -c cloudflared

# æ£€æŸ¥ Tunnel çŠ¶æ€
kubectl exec -it <pod-name> -c cloudflared -- cloudflared tunnel info
```

**WARP Connector è¿æ¥é—®é¢˜ï¼š**
```bash
# æŸ¥çœ‹ WARP æ—¥å¿—
kubectl logs -n warp-connector <pod-name>

# æ£€æŸ¥è·¯ç”±è¡¨
kubectl exec -it <warp-pod> -- ip route

# æµ‹è¯•è¿æ¥
kubectl exec -it <warp-pod> -- ping <internal-ip>
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Cloudflared å¿«é€Ÿå¼€å§‹](./CLOUDFLARED_QUICKSTART.md)
- [é›¶ä¿¡ä»»ç½‘ç»œé…ç½®](./ZERO_TRUST_NETWORK.md)
- [ç›‘æ§ç³»ç»Ÿéƒ¨ç½²](./OBSERVABILITY_SETUP.md)

---

## ğŸ“ æ¶æ„å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆé€‰æ‹©åŒè½¨åˆ¶ï¼Ÿ

**ä¼ ç»Ÿå•ä¸€æ–¹æ¡ˆçš„é—®é¢˜ï¼š**
- âŒ åªç”¨ Cloudflaredï¼šæ— æ³•å®ç°æœåŠ¡å™¨é—´é«˜æ•ˆé€šä¿¡
- âŒ åªç”¨ VPNï¼šç¼ºå°‘ç°ä»£åŒ–çš„è®¿é—®æ§åˆ¶å’Œ DDoS é˜²æŠ¤
- âŒ åªç”¨å…¬ç½‘æš´éœ²ï¼šå®‰å…¨é£é™©é«˜ï¼Œç®¡ç†å¤æ‚

**åŒè½¨åˆ¶çš„ä¼˜åŠ¿ï¼š**
- âœ… **èŒè´£åˆ†ç¦»**ï¼šå…¬ç½‘è®¿é—®å’Œå†…ç½‘äº’è”å„å¸å…¶èŒ
- âœ… **çµæ´»æ€§**ï¼šå¯ç‹¬ç«‹æ‰©å±•å’Œé…ç½®
- âœ… **å®‰å…¨æ€§**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œæœ€å°æƒé™åŸåˆ™
- âœ… **æ€§èƒ½**ï¼šé’ˆå¯¹ä¸åŒåœºæ™¯ä¼˜åŒ–
- âœ… **å¯è§‚æµ‹æ€§**ï¼šç»Ÿä¸€çš„æ—¥å¿—å’Œç›‘æ§

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|-----|------|-----|
| 1.0 | 2025-10-29 | åˆå§‹ç‰ˆæœ¬ï¼Œå®šä¹‰åŒè½¨åˆ¶æ¶æ„ |

---

**ç»´æŠ¤è€…ï¼š** AnixOps Team  
**æœ€åæ›´æ–°ï¼š** 2025-10-29
