---
# =============================================================================
# Prerequisites Checks
# =============================================================================

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  failed_when: false
  changed_when: false
  when: k8s_provider == 'kind'  # Docker only required for Kind

- name: Display Docker status
  ansible.builtin.debug:
    msg: "{{ 'Docker is installed: ' + docker_check.stdout if docker_check.rc == 0 else 'Docker is not installed' }}"
  when: k8s_provider == 'kind'

- name: Fail if Docker is not installed (Kind only)
  ansible.builtin.fail:
    msg: "Docker is required but not installed. Please install Docker first."
  when: 
    - k8s_provider == 'kind'
    - docker_check.rc != 0

- name: Check if kubectl is installed
  ansible.builtin.command: kubectl version --client
  register: kubectl_check
  failed_when: false
  changed_when: false

- name: Install kubectl if not present
  when: kubectl_check.rc != 0
  block:
    - name: Download kubectl
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
      become: yes

    - name: Verify kubectl installation
      ansible.builtin.command: kubectl version --client
      changed_when: false

- name: Check if Helm is installed
  ansible.builtin.command: helm version
  register: helm_check
  failed_when: false
  changed_when: false
  when: false  # Helm不再使用 | Helm is no longer used

- name: Install Helm if not present
  when: false  # Helm不再使用 | Helm is no longer used
  block:
    - name: Download Helm installation script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get-helm-3.sh
        mode: '0755'

    - name: Install Helm
      ansible.builtin.command: /tmp/get-helm-3.sh
      become: yes
      changed_when: true

    - name: Verify Helm installation
      ansible.builtin.command: helm version
      changed_when: false

- name: Display tools status
  ansible.builtin.debug:
    msg:
      - "✅ Prerequisites check completed"
      - "Docker: {{ 'Installed' if (k8s_provider == 'kind' and docker_check.rc == 0) else 'Not Required (K3s)' if k8s_provider == 'k3s' else 'Not Checked' }}"
      - "kubectl: {{ 'Installed' if kubectl_check.rc == 0 else 'Will be installed' }}"
      - "Helm: Not Used"
