---
# Prometheus Configuration Template

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'anixops'
    environment: '{{ ansible_environment | default("production") }}'

alerting:
  alertmanagers:
    - static_configs:
        - targets: []

rule_files:
  # - "alerts/*.yml"

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node_exporter'
    static_configs:
{% for host in groups['all'] %}
{% set env_var_name = host | upper | replace('-', '_') ~ '_V4_SSH' %}
{% set instance_ip = lookup('env', env_var_name) %}
      - targets:
          - '{{ instance_ip }}:9100'
        labels:
          alias: '{{ server_aliases.get(host, {}).get("alias", host) }}'
          location: '{{ server_aliases.get(host, {}).get("location", "unknown") }}'
          environment: '{{ server_aliases.get(host, {}).get("environment", "unknown") }}'
          description: '{{ server_aliases.get(host, {}).get("description", "") }}'
{% endfor %}
    # 重新标记配置：用 alias 替换 instance 显示
    metric_relabel_configs:
      # 保存原始 instance 到 target_ip
      - source_labels: [instance]
        target_label: target_ip
      # 用 alias 替换 instance 标签
      - source_labels: [alias]
        target_label: instance
      # 删除不需要的标签
      - regex: 'server|hostname'
        action: labeldrop
