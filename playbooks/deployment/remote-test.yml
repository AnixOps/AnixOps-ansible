---
# =============================================================================
# Remote K8s Test Playbook (K3s)
# =============================================================================
# ç”¨äºåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šåˆ›å»º K3s é›†ç¾¤ï¼ˆä¸ä½¿ç”¨ Helmï¼Œä¸è‡ªåŠ¨éƒ¨ç½²åº”ç”¨ï¼‰
# Create K3s cluster on remote servers (without Helm, no automatic application deployment)
# =============================================================================
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#
#   åŸºæœ¬ä½¿ç”¨ | Basic usage:
#     ansible-playbook playbooks/deployment/remote-test.yml -i inventory/hosts.yml
#
#   é€šè¿‡è„šæœ¬ | Via script:
#     bash scripts/anixops.sh deploy-remote-test
#
# è¯´æ˜ï¼š
#   - åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå®‰è£… K3s
#   - ä¸ä½¿ç”¨ Helm
#   - ä¸è‡ªåŠ¨éƒ¨ç½²ä»»ä½•åº”ç”¨ï¼ˆåŒ…æ‹¬ Cloudflaredï¼‰
#   - åº”ç”¨éƒ¨ç½²è¯·ä½¿ç”¨ kubectl apply -f <manifest>
#
# =============================================================================

- name: "Provision Remote K3s Cluster"
  hosts: k8s_test
  gather_facts: yes
  become: yes
  
  tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Provision Remote K3s Cluster                                 â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target: {{ inventory_hostname }} ({{ ansible_host }})"
          - "ğŸ”§ Provider: K3s"
          - "ğŸ“¦ Cluster: {{ cluster_name | default('k3s-test') }}"
          - "ğŸŒ Location: {{ server_aliases[inventory_hostname].location | default('Unknown') }}"

    - name: Include k8s_provision role
      ansible.builtin.include_role:
        name: k8s_provision
      tags:
        - k8s
        - provision

- name: "Download kubeconfig from remote server"
  hosts: k8s_test
  gather_facts: no
  become: yes
  
  tasks:
    - name: Display kubeconfig download information
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Download Kubeconfig                                          â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Fetch kubeconfig from remote server
      ansible.builtin.fetch:
        src: "{{ kubeconfig_remote_path }}"
        dest: "/tmp/k3s-{{ inventory_hostname }}-kubeconfig.yaml"
        flat: yes
      tags:
        - kubeconfig

    - name: Modify kubeconfig server address
      delegate_to: localhost
      ansible.builtin.replace:
        path: "/tmp/k3s-{{ inventory_hostname }}-kubeconfig.yaml"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: "https://{{ ansible_host }}:6443"
      tags:
        - kubeconfig

    - name: Display kubeconfig location
      ansible.builtin.debug:
        msg:
          - "âœ… Kubeconfig downloaded to: /tmp/k3s-{{ inventory_hostname }}-kubeconfig.yaml"
          - ""
          - "Use it with:"
          - "  export KUBECONFIG=/tmp/k3s-{{ inventory_hostname }}-kubeconfig.yaml"
          - "  kubectl get nodes"

- name: "Display Deployment Summary"
  hosts: k8s_test
  gather_facts: no
  
  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ‰ K3s Cluster Created Successfully!                          â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… K3s cluster is running on {{ ansible_host }}"
          - "âœ… Kubeconfig is available locally"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "  1. Export kubeconfig:"
          - "     export KUBECONFIG=/tmp/k3s-{{ inventory_hostname }}-kubeconfig.yaml"
          - ""
          - "  2. Check cluster:"
          - "     kubectl cluster-info"
          - "     kubectl get nodes"
          - ""
          - "  3. Deploy applications:"
          - "     kubectl apply -f k8s_manifests/api-with-cloudflared-sidecar/deployment.yaml"
          - ""
          - "ğŸ” Useful Commands:"
          - "  â€¢ View all pods: kubectl get pods --all-namespaces"
          - "  â€¢ SSH to server: ssh root@{{ ansible_host }}"
          - "  â€¢ Uninstall K3s: /usr/local/bin/k3s-uninstall.sh"
