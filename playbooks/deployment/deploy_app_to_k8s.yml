---
# =============================================================================
# éƒ¨ç½²åº”ç”¨åˆ° K8s é›†ç¾¤
# Deploy Application to K8s Cluster
# =============================================================================
# æ­¤ playbook ç”¨äºå°†åº”ç”¨éƒ¨ç½²åˆ°è¿œç¨‹æˆ–æœ¬åœ° K8s é›†ç¾¤
# This playbook deploys applications to remote or local K8s clusters
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#   ansible-playbook playbooks/deployment/deploy_app_to_k8s.yml \
#     -i inventory/hosts.yml \
#     -e "target_group=nginx_test" \
#     -e "manifest_dir=k8s_manifests/api-with-cloudflared-sidecar"
# =============================================================================

- name: Deploy Application to K8s Cluster
  hosts: "{{ target_group | default('nginx_test') }}"
  gather_facts: yes
  become: no
  
  vars:
    # é»˜è®¤é…ç½® | Default Configuration
    default_manifest_dir: "k8s_manifests/api-with-cloudflared-sidecar"
    default_namespace: "default"
    actual_namespace: "{{ app_namespace | default(default_namespace) }}"
    actual_manifest_dir: "{{ app_manifest_path | default(manifest_dir) | default(default_manifest_dir) }}"
    manifest_files:
      - namespace.yaml
      - configmap.yaml
      - secret.yaml
      - deployment.yaml
      - service.yaml
      - ingress.yaml
    
  tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸš€ Deploy Application to K8s Cluster                        â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target Host: {{ inventory_hostname }}"
          - "ğŸ·ï¸  App Name: {{ app_name | default('unknown') }}"
          - "ğŸ“¦ Namespace: {{ actual_namespace }}"
          - "ğŸ”§ Deployment Type: {{ deployment_type | default('local') }}"
          - "ğŸ“ Manifest Dir: {{ actual_manifest_dir }}"
          - "ğŸŒ Cluster: {{ cluster_endpoint | default('localhost') }}"
      tags:
        - always

    - name: Check if kubeconfig exists locally
      ansible.builtin.stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat
      delegate_to: localhost
      when: deployment_type == 'remote_k3s'

    - name: Fail if kubeconfig not found
      ansible.builtin.fail:
        msg: |
          âŒ Kubeconfig not found at {{ kubeconfig_path }}
          Please run the cluster provisioning first:
            cd scripts && bash anixops.sh deploy-remote-test
      when: 
        - deployment_type == 'remote_k3s'
        - not kubeconfig_stat.stat.exists
    
    - name: Display kubeconfig status
      ansible.builtin.debug:
        msg: "âœ… Kubeconfig found: {{ kubeconfig_path }}"
      when: 
        - deployment_type == 'remote_k3s'
        - kubeconfig_stat.stat.exists

    - name: Check if manifest directory exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../{{ actual_manifest_dir }}"
      register: manifest_dir_stat
      delegate_to: localhost

    - name: Fail if manifest directory not found
      ansible.builtin.fail:
        msg: "âŒ Manifest directory not found: {{ actual_manifest_dir }}"
      when: not manifest_dir_stat.stat.exists

    - name: Find all YAML manifests in directory
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../{{ actual_manifest_dir }}"
        patterns: "*.yaml,*.yml"
        excludes: "*.example.yaml,*.example.yml"
      register: found_manifests
      delegate_to: localhost

    - name: Display found manifests
      ansible.builtin.debug:
        msg:
          - "ğŸ“„ Found {{ found_manifests.files | length }} manifest files:"
          - "{{ found_manifests.files | map(attribute='path') | map('basename') | list }}"

    - name: Apply Kubernetes manifests
      ansible.builtin.shell: |
        export KUBECONFIG="{{ kubeconfig_path }}"
        kubectl apply -f "{{ item.path }}"
      loop: "{{ found_manifests.files | sort(attribute='path') }}"
      register: kubectl_apply
      delegate_to: localhost
      changed_when: "'configured' in kubectl_apply.stdout or 'created' in kubectl_apply.stdout"
      failed_when: kubectl_apply.rc != 0

    - name: Display apply results
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ kubectl_apply.results }}"
      when: item.stdout_lines is defined

    - name: Wait for deployments to be ready
      ansible.builtin.shell: |
        export KUBECONFIG="{{ kubeconfig_path }}"
        kubectl rollout status deployment -n {{ actual_namespace }} --timeout=300s
      register: rollout_status
      delegate_to: localhost
      changed_when: false
      failed_when: false

    - name: Get deployment status
      ansible.builtin.shell: |
        export KUBECONFIG="{{ kubeconfig_path }}"
        kubectl get deployments,pods,services -n {{ actual_namespace }}
      register: deployment_status
      delegate_to: localhost
      changed_when: false

    - name: Display deployment status
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  âœ… Deployment Complete                                       â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "{{ deployment_status.stdout_lines }}"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "  â€¢ Check pods: kubectl get pods -n {{ actual_namespace }}"
          - "  â€¢ Check logs: kubectl logs -n {{ actual_namespace }} <pod-name>"
          - "  â€¢ Port forward: kubectl port-forward -n {{ actual_namespace }} svc/<service-name> 8080:80"

    - name: Save deployment info to file
      ansible.builtin.copy:
        content: |
          Deployment Information
          ======================
          Date: {{ ansible_date_time.iso8601 }}
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          App: {{ app_name }}
          Namespace: {{ actual_namespace }}
          Cluster: {{ cluster_endpoint }}
          Kubeconfig: {{ kubeconfig_path }}
          
          Status:
          {{ deployment_status.stdout }}
        dest: "/tmp/deployment-{{ app_name }}-{{ ansible_date_time.epoch }}.log"
      delegate_to: localhost

    - name: Display log file location
      ansible.builtin.debug:
        msg: "ğŸ“ Deployment log saved to: /tmp/deployment-{{ app_name }}-{{ ansible_date_time.epoch }}.log"
