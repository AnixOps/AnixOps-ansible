---
# =============================================================================
# Production Deployment Playbook
# =============================================================================
# åœ¨ç”Ÿäº§ç¯å¢ƒè¿œç¨‹æœåŠ¡å™¨ä¸Šéƒ¨ç½² K3s å’Œ Cloudflared
# Deploy K3s and Cloudflared on production remote servers
# =============================================================================
#
# âš ï¸  è­¦å‘Š | WARNING:
#   è¿™å°†åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šéƒ¨ç½²çœŸå®çš„ Kubernetes é›†ç¾¤ï¼
#   This will deploy a real Kubernetes cluster on production servers!
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#
#   æ–¹å¼ 1: ä½¿ç”¨å‘½ä»¤è¡Œä¼ é€’ Token | Pass token via command line:
#     ansible-playbook playbook-production.yml \
#       --extra-vars "cloudflare_tunnel_token=your-token-here"
#
#   æ–¹å¼ 2: ä½¿ç”¨ Ansible Vault (æ¨è) | Use Ansible Vault (recommended):
#     # åˆ›å»ºåŠ å¯†çš„ secrets æ–‡ä»¶ | Create encrypted secrets file
#     ansible-vault create vars/secrets.yml
#     
#     # åœ¨æ–‡ä»¶ä¸­æ·»åŠ  | Add in the file:
#     ---
#     cloudflare_tunnel_token: "your-token-here"
#     
#     # è¿è¡Œ playbook | Run playbook
#     ansible-playbook playbook-production.yml \
#       --extra-vars "@vars/secrets.yml" \
#       --vault-password-file ~/.vault_pass
#
# å‰ç½®è¦æ±‚ | Prerequisites:
#   1. å·²é…ç½® inventories/production/hosts.ini
#   2. SSH å¯†é’¥å·²é…ç½®
#   3. ç›®æ ‡æœåŠ¡å™¨å¯ä»¥è®¿é—®äº’è”ç½‘
#   4. ç›®æ ‡æœåŠ¡å™¨å·²å®‰è£… Docker
#
# =============================================================================

- name: "Pre-flight Check: Verify Production Environment"
  hosts: k8s_production
  gather_facts: yes
  
  tasks:
    - name: Display pre-flight check information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Pre-flight Check: Production Environment                     â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target Server: {{ inventory_hostname }}"
          - "ğŸŒ IP Address: {{ ansible_host }}"
          - "ğŸ’» OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "ğŸ”§ Python: {{ ansible_python_version }}"

    - name: Check server connectivity
      ansible.builtin.ping:

    - name: Display connectivity success
      ansible.builtin.debug:
        msg: "âœ… Server connectivity verified"

- name: "Stage 1: Provision Production Kubernetes Cluster (K3s)"
  hosts: k8s_production
  gather_facts: no
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Stage 1: Provision Production Kubernetes Cluster (K3s)       â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target: {{ inventory_hostname }}"
          - "ğŸ”§ Provider: K3s"
          - "ğŸ“¦ Version: {{ k3s_version }}"

    - name: Confirm production deployment
      ansible.builtin.pause:
        prompt: |
          
          âš ï¸  WARNING: You are about to deploy K3s on a PRODUCTION server!
          
          This will:
          - Install K3s on {{ inventory_hostname }}
          - Modify system configurations
          - Open required ports
          
          Are you sure you want to continue? (yes/no)
      when: environment == 'production'
      register: confirm_deploy

    - name: Fail if not confirmed
      ansible.builtin.fail:
        msg: "Deployment cancelled by user"
      when: 
        - environment == 'production'
        - confirm_deploy.user_input | lower != 'yes'

    - name: Include k8s_provision role
      ansible.builtin.include_role:
        name: k8s_provision
      tags:
        - k8s
        - provision

- name: "Stage 2: Deploy Cloudflared to Production Kubernetes"
  hosts: k8s_production
  gather_facts: no
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Stage 2: Deploy Cloudflared to Production Kubernetes         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸš€ Deploying Cloudflared..."
          - "ğŸ“¦ Namespace: {{ cloudflared_namespace }}"
          - "ğŸ“¦ Release: {{ cloudflared_release_name }}"
          - "ğŸ“Š Replicas: {{ cloudflared_replica_count }}"

    - name: Include cloudflared_deploy role
      ansible.builtin.include_role:
        name: cloudflared_deploy
      tags:
        - cloudflared
        - deploy

- name: "Stage 3: Display Production Deployment Summary"
  hosts: k8s_production
  gather_facts: no
  
  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ‰ Production Deployment Completed Successfully!              â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… K3s cluster is running on {{ inventory_hostname }}"
          - "âœ… Cloudflared is deployed with {{ cloudflared_replica_count }} replicas"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "  1. Access your server: ssh {{ ansible_user }}@{{ ansible_host }}"
          - "  2. Check cluster: kubectl get nodes"
          - "  3. Check pods: kubectl get pods -n {{ cloudflared_namespace }}"
          - "  4. Check logs: kubectl logs -n {{ cloudflared_namespace }} -l app.kubernetes.io/name=cloudflared"
          - ""
          - "ğŸ” Useful Commands (on server):"
          - "  â€¢ View all pods: kubectl get pods --all-namespaces"
          - "  â€¢ Get cluster info: kubectl cluster-info"
          - "  â€¢ Check k3s status: systemctl status k3s"
          - ""
          - "ğŸ“ Important Files:"
          - "  â€¢ Kubeconfig: {{ kubeconfig_path }}"
          - "  â€¢ K3s config: /etc/rancher/k3s/config.yaml"
