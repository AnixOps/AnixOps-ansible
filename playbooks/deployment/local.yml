---
# =============================================================================
# Local Development Playbook
# =============================================================================
# ç”¨äºåœ¨æœ¬åœ° Kind é›†ç¾¤ä¸Šéƒ¨ç½² Cloudflared
# Deploy Cloudflared on local Kind cluster
# =============================================================================
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#
#   æ–¹å¼ 1: ä½¿ç”¨å‘½ä»¤è¡Œä¼ é€’ Token | Pass token via command line:
#     ansible-playbook playbook-local.yml \
#       --extra-vars "cloudflare_tunnel_token=your-token-here"
#
#   æ–¹å¼ 2: ä½¿ç”¨ç¯å¢ƒå˜é‡ | Use environment variable:
#     export CLOUDFLARE_TUNNEL_TOKEN="your-token-here"
#     ansible-playbook playbook-local.yml
#
#   æ–¹å¼ 3: ä½¿ç”¨ Ansible Vault | Use Ansible Vault:
#     ansible-playbook playbook-local.yml \
#       --extra-vars "@vars/secrets.yml" \
#       --vault-password-file ~/.vault_pass
#
# =============================================================================

- name: "Stage 1: Provision Local Kubernetes Cluster (Kind)"
  hosts: k8s_local
  gather_facts: no
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Stage 1: Provision Local Kubernetes Cluster (Kind)           â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target: localhost"
          - "ğŸ”§ Provider: Kind"
          - "ğŸ“¦ Cluster: {{ kind_cluster_name }}"

    - name: Include k8s_provision role
      ansible.builtin.include_role:
        name: k8s_provision
      tags:
        - k8s
        - provision

- name: "Stage 2: Deploy Cloudflared to Kubernetes"
  hosts: k8s_local
  gather_facts: no
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Stage 2: Deploy Cloudflared to Kubernetes                    â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸš€ Deploying Cloudflared..."
          - "ğŸ“¦ Namespace: {{ cloudflared_namespace }}"
          - "ğŸ“¦ Release: {{ cloudflared_release_name }}"

    - name: Include cloudflared_deploy role
      ansible.builtin.include_role:
        name: cloudflared_deploy
      tags:
        - cloudflared
        - deploy

- name: "Stage 3: Display Deployment Summary"
  hosts: k8s_local
  gather_facts: no
  
  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ‰ Local Deployment Completed Successfully!                   â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… Kind cluster is running"
          - "âœ… Cloudflared is deployed"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "  1. Check cluster: kubectl cluster-info --context kind-{{ kind_cluster_name }}"
          - "  2. Check pods: kubectl get pods -n {{ cloudflared_namespace }}"
          - "  3. Check logs: kubectl logs -n {{ cloudflared_namespace }} -l app.kubernetes.io/name=cloudflared"
          - ""
          - "ğŸ” Useful Commands:"
          - "  â€¢ Switch context: kubectl config use-context kind-{{ kind_cluster_name }}"
          - "  â€¢ Get all resources: kubectl get all -n {{ cloudflared_namespace }}"
          - "  â€¢ Delete cluster: kind delete cluster --name {{ kind_cluster_name }}"
