---
# =============================================================================
# Local Development Playbook
# =============================================================================
# ç”¨äºåœ¨æœ¬åœ°åˆ›å»º Kind é›†ç¾¤ï¼ˆä¸ä½¿ç”¨ Helmï¼Œä¸è‡ªåŠ¨éƒ¨ç½²åº”ç”¨ï¼‰
# Create local Kind cluster (without Helm, no automatic application deployment)
# =============================================================================
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#
#   åŸºæœ¬ä½¿ç”¨ | Basic usage:
#     ansible-playbook playbooks/deployment/local.yml
#
#   é€šè¿‡è„šæœ¬ | Via script:
#     bash scripts/anixops.sh deploy-local
#
# è¯´æ˜ï¼š
#   - åªåˆ›å»º Kind é›†ç¾¤
#   - ä¸ä½¿ç”¨ Helm
#   - ä¸è‡ªåŠ¨éƒ¨ç½²ä»»ä½•åº”ç”¨ï¼ˆåŒ…æ‹¬ Cloudflaredï¼‰
#   - åº”ç”¨éƒ¨ç½²è¯·ä½¿ç”¨ kubectl apply -f <manifest>
#
# =============================================================================

- name: "Provision Local Kubernetes Cluster (Kind)"
  hosts: k8s_local
  gather_facts: no
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Provision Local Kubernetes Cluster (Kind)                    â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ¯ Target: localhost"
          - "ğŸ”§ Provider: Kind"
          - "ğŸ“¦ Cluster: {{ kind_cluster_name }}"

    - name: Include k8s_provision role
      ansible.builtin.include_role:
        name: k8s_provision
      tags:
        - k8s
        - provision

- name: "Display Deployment Summary"
  hosts: k8s_local
  gather_facts: no
  
  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸ‰ Kind Cluster Created Successfully!                         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… Kind cluster is running"
          - "âœ… Kubectl is configured"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "  1. Check cluster: kubectl cluster-info --context kind-{{ kind_cluster_name }}"
          - "  2. View nodes: kubectl get nodes"
          - "  3. View pods: kubectl get pods --all-namespaces"
          - ""
          - "ğŸ“¦ Deploy applications using kubectl:"
          - "  kubectl apply -f k8s_manifests/api-with-cloudflared-sidecar/deployment.yaml"
          - ""
          - "ğŸ” Useful Commands:"
          - "  â€¢ Switch context: kubectl config use-context kind-{{ kind_cluster_name }}"
          - "  â€¢ Delete cluster: kind delete cluster --name {{ kind_cluster_name }}"
          - "  â€¢ Cleanup: bash scripts/anixops.sh cleanup-local"
