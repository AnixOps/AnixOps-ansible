---
# éƒ¨ç½² WARP Connector åˆ°å®¿ä¸»æœº
# Deploy WARP Connector to Host Machines
#
# æ­¤ playbook ç›´æ¥åœ¨æœåŠ¡å™¨å®¿ä¸»æœºä¸Šéƒ¨ç½² WARP Connector
# æ¯” K8s éƒ¨ç½²æ›´ç®€å•ï¼Œè®©æ•´ä¸ªæœåŠ¡å™¨éƒ½èƒ½äº«å— WARP ç½‘ç»œ
#
# ä½¿ç”¨æ–¹æ³•:
#   # æ–¹å¼ 1: ä½¿ç”¨é»˜è®¤ inventory (æ¨èï¼Œansible.cfg å·²é…ç½®)
#   ansible-playbook playbooks/deployment/deploy_warp_host.yml -e "warp_token=YOUR_WARP_TOKEN"
#
#   # æ–¹å¼ 2: æ˜¾å¼æŒ‡å®š inventory
#   ansible-playbook playbooks/deployment/deploy_warp_host.yml \
#     -i inventory/hosts.yml \
#     -e "warp_token=YOUR_WARP_TOKEN"
#
# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡:
#   export WARP_TOKEN=your_token
#   ansible-playbook playbooks/deployment/deploy_warp_host.yml

- name: éƒ¨ç½² WARP Connector åˆ°å®¿ä¸»æœº
  hosts: dev_servers
  become: yes
  gather_facts: yes
  
  vars:
    # ä»ç¯å¢ƒå˜é‡æˆ–å‘½ä»¤è¡Œå‚æ•°è·å– token
    warp_token: "{{ lookup('env', 'WARP_TOKEN') | default(warp_token | default('')) }}"
    warp_install_method: "package"  # å¯é€‰: package æˆ– docker
    warp_log_level: "info"
  
  pre_tasks:
    - name: æ˜¾ç¤ºéƒ¨ç½²æ¨ªå¹…
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                                                          â•‘"
          - "â•‘      ğŸŒ éƒ¨ç½² WARP Connector åˆ°å®¿ä¸»æœº                     â•‘"
          - "â•‘      ğŸŒ Deploy WARP Connector to Host Machines          â•‘"
          - "â•‘                                                          â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
          - "  â€¢ ç›®æ ‡ä¸»æœº: {{ ansible_play_hosts | length }} å°"
          - "  â€¢ å®‰è£…æ–¹å¼: {{ warp_install_method }}"
          - "  â€¢ æ—¥å¿—çº§åˆ«: {{ warp_log_level }}"
          - ""
      run_once: yes
  
  roles:
    - role: warp_connector
      tags: ['warp', 'network']
  
  post_tasks:
    - name: ç­‰å¾… WARP è¿æ¥ç¨³å®š
      ansible.builtin.pause:
        seconds: 10
        prompt: "ç­‰å¾… WARP è¿æ¥å»ºç«‹..."
    
    - name: æ”¶é›† WARP çŠ¶æ€ä¿¡æ¯ (åŒ…å®‰è£…æ–¹å¼)
      ansible.builtin.command:
        cmd: warp-cli status
      register: warp_status_info
      changed_when: false
      failed_when: false
      when: warp_install_method == "package"
    
    - name: æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                                                          â•‘"
          - "â•‘      âœ… WARP Connector éƒ¨ç½²å®Œæˆ                          â•‘"
          - "â•‘      âœ… WARP Connector Deployment Complete              â•‘"
          - "â•‘                                                          â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          - ""
          - "ğŸ“‹ åç»­æ­¥éª¤:"
          - "  1. åœ¨ Cloudflare Zero Trust ä¸­é…ç½®è®¿é—®ç­–ç•¥"
          - "  2. æµ‹è¯•æœåŠ¡å™¨é—´çš„è¿é€šæ€§"
          - "  3. é…ç½®åº”ç”¨ç¨‹åºä½¿ç”¨ WARP ç½‘ç»œ"
          - ""
          - "ğŸ” å¸¸ç”¨å‘½ä»¤:"
          - "  â€¢ æŸ¥çœ‹çŠ¶æ€: warp-cli status"
          - "  â€¢ æŸ¥çœ‹æ—¥å¿—: journalctl -u warp-svc -f"
          - "  â€¢ é‡å¯æœåŠ¡: systemctl restart warp-svc"
          - ""
          - "ğŸ“š æ–‡æ¡£: roles/warp_connector/README.md"
          - ""
