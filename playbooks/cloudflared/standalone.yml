---
# =============================================================================
# Cloudflare Tunnel éƒ¨ç½² Playbook | Cloudflare Tunnel Deployment Playbook
# =============================================================================
# æ­¤ Playbook ç”¨äºåœ¨æ‰€æœ‰ç›®æ ‡èŠ‚ç‚¹ä¸Šéƒ¨ç½² Cloudflare Tunnel (cloudflared)
# This Playbook deploys Cloudflare Tunnel (cloudflared) on all target nodes
# =============================================================================
#
# ğŸ”’ å®‰å…¨è­¦å‘Š | Security Warning:
#   æ­¤ Playbook ä¸åŒ…å«ä»»ä½•ç§˜å¯†ä¿¡æ¯ï¼
#   This Playbook contains NO secrets!
#
# ğŸ“– ä½¿ç”¨æ–¹æ³• | Usage:
#
#   æœ¬åœ°è¿è¡Œ | Local Execution:
#     1. åˆ›å»º .env æ–‡ä»¶ | Create .env file:
#        echo 'export CF_TUNNEL_TOKEN="your-tunnel-token"' > .env
#
#     2. åŠ è½½ç¯å¢ƒå˜é‡ | Load environment variables:
#        source .env
#
#     3. è¿è¡Œ Playbook | Run playbook:
#        ansible-playbook playbooks/cloudflared_playbook.yml
#
#   CI/CD (GitHub Actions):
#     - GitHub Workflow ä¼šè‡ªåŠ¨ä» secrets.CF_TUNNEL_TOKEN è¯»å–
#     - GitHub Workflow will automatically read from secrets.CF_TUNNEL_TOKEN
#
# =============================================================================

- name: Deploy Cloudflare Tunnel on all nodes
  hosts: all
  become: yes

  vars:
    # -------------------------------------------------------------------------
    # ä»ç¯å¢ƒå˜é‡è‡ªåŠ¨è¯»å– Tunnel Token
    # Automatically read Tunnel Token from environment variable
    # -------------------------------------------------------------------------
    #
    # å·¥ä½œåŸç† | How it works:
    #   ä¼˜å…ˆä½¿ç”¨æ–°å˜é‡å CLOUDFLARE_TUNNEL_TOKEN
    #   å¦‚æœæœªæ‰¾åˆ°ï¼Œå°è¯•æ—§å˜é‡å CF_TUNNEL_TOKEN (å‘åå…¼å®¹)
    #   å¦‚æœéƒ½æœªæ‰¾åˆ°ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆRole çš„ assert ä»»åŠ¡ä¼šæ•è·é”™è¯¯ï¼‰
    #
    # æœ¬åœ° | Local:
    #   export CLOUDFLARE_TUNNEL_TOKEN="your-token" æˆ– source .env
    #
    # CI/CD:
    #   GitHub Workflow ä¼šè®¾ç½® CLOUDFLARE_TUNNEL_TOKEN ç¯å¢ƒå˜é‡
    #   GitHub Workflow will set the CLOUDFLARE_TUNNEL_TOKEN environment variable
    #
    # æ³¨æ„: CF_TUNNEL_TOKEN å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ CLOUDFLARE_TUNNEL_TOKEN
    # Note: CF_TUNNEL_TOKEN is deprecated, please use CLOUDFLARE_TUNNEL_TOKEN
    #
    cf_tunnel_token: "{{ lookup('env', 'CLOUDFLARE_TUNNEL_TOKEN') | default(lookup('env', 'CF_TUNNEL_TOKEN'), true) | default('') }}"

  pre_tasks:
    - name: Deployment banner
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  ğŸš€ Cloudflare Tunnel Deployment Starting                â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“¦ Target hosts: {{ groups['all'] | length }} node(s)"
          - "ğŸ” Token source: Environment variable (CF_TUNNEL_TOKEN)"
          - "ğŸ—ï¸  Architecture: {{ ansible_architecture }}"
          - "ğŸ‘¤ Ansible user: {{ ansible_user }}"
      tags:
        - always

    - name: Check system requirements
      ansible.builtin.assert:
        that:
          - ansible_os_family in ['Debian', 'RedHat']
          - ansible_architecture in ['x86_64', 'aarch64', 'arm64']
        fail_msg: |
          âŒ Unsupported system detected!
          OS Family: {{ ansible_os_family }}
          Architecture: {{ ansible_architecture }}

          Supported:
            - OS: Debian, Ubuntu, RedHat, CentOS
            - Arch: x86_64, aarch64, arm64
        success_msg: "âœ… System requirements met"
      tags:
        - validation

  roles:
    - role: anix_cloudflared
      tags:
        - cloudflared

  post_tasks:
    - name: Deployment completion summary
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  âœ… Cloudflare Tunnel Deployment Completed Successfully   â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Next Steps:"
          - "  1. Verify tunnel status:"
          - "     ansible all -m shell -a 'systemctl status cloudflared'"
          - ""
          - "  2. Check logs:"
          - "     ansible all -m shell -a 'journalctl -u cloudflared -n 50'"
          - ""
          - "  3. Test connectivity from Cloudflare Dashboard:"
          - "     https://one.dash.cloudflare.com/"
          - ""
          - "ğŸ” Security Reminder:"
          - "  - Token is stored in systemd service memory only"
          - "  - Never commit secrets to Git!"
          - "  - Rotate tokens regularly via Cloudflare Dashboard"
      tags:
        - always
