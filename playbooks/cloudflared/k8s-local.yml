---
# =============================================================================
# Cloudflare Tunnel - æœ¬åœ° Kubernetes éƒ¨ç½² (å¼€å‘ç¯å¢ƒ)
# Cloudflare Tunnel - Local Kubernetes Deployment (Development)
# =============================================================================
# ç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•ï¼Œä½¿ç”¨æœ¬åœ°çš„ Kubernetes é›†ç¾¤
# For local development and testing, using local Kubernetes cluster
#
# æ”¯æŒçš„æœ¬åœ° K8s ç¯å¢ƒ | Supported local K8s environments:
#   - Minikube
#   - kind (Kubernetes in Docker)
#   - Docker Desktop Kubernetes
#   - K3s/K3d
#   - MicroK8s
#
# å‰ç½®è¦æ±‚ | Prerequisites:
#   1. æœ¬åœ°å·²å®‰è£…å¹¶è¿è¡Œ Kubernetes é›†ç¾¤
#   2. kubectl å·²é…ç½®å¥½ (~/.kube/config)
#   3. Helm 3.x å·²å®‰è£…
#   4. å·²è·å– Cloudflare Tunnel Token
#
# ä½¿ç”¨æ–¹æ³• | Usage:
#   ansible-playbook playbooks/cloudflared_k8s_local.yml \
#     --extra-vars "cloudflare_tunnel_token=eyJhIjoiY2FmZS0xMjM0..."
#
#   æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ | Or use environment variable:
#   export CLOUDFLARE_TUNNEL_TOKEN="eyJhIjoiY2FmZS0xMjM0..."
#   ansible-playbook playbooks/cloudflared_k8s_local.yml
# =============================================================================

- name: "ğŸš€ Deploy Cloudflare Tunnel on Local Kubernetes (Development)"
  hosts: localhost
  connection: local
  gather_facts: yes
  
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:{{ ansible_env.PATH }}"
    KUBECONFIG: "{{ kubeconfig_path | default('~/.kube/config') }}"
  
  vars:
    # -------------------------------------------------------------------------
    # éƒ¨ç½²æ¨¡å¼æ ‡è¯† | Deployment Mode
    # -------------------------------------------------------------------------
    deployment_mode: "local"
    deployment_environment: "development"
    
    # -------------------------------------------------------------------------
    # Cloudflare Tunnel é…ç½® | Cloudflare Tunnel Configuration
    # -------------------------------------------------------------------------
    # Tunnel Tokenï¼ˆä»ç¯å¢ƒå˜é‡æˆ–å‘½ä»¤è¡Œå‚æ•°è¯»å–ï¼‰
    cloudflare_tunnel_token: "{{ lookup('env', 'CLOUDFLARE_TUNNEL_TOKEN') | default('', true) }}"
    
    # -------------------------------------------------------------------------
    # Kubernetes é…ç½® | Kubernetes Configuration
    # -------------------------------------------------------------------------
    # æœ¬åœ° kubeconfig è·¯å¾„
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    
    # Namespace
    k8s_namespace: "cloudflare-tunnel"
    
    # Helm Release åç§°
    helm_release_name: "cloudflared"
    
    # Helm Chart é…ç½®
    helm_chart_repo: "https://cloudflare.github.io/helm-charts"
    helm_chart_name: "cloudflare/cloudflared"
    helm_chart_version: ""  # ç•™ç©ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ | Leave empty for latest
    
    # -------------------------------------------------------------------------
    # æœ¬åœ°å¼€å‘ç¯å¢ƒèµ„æºé…ç½® | Local Development Resource Configuration
    # -------------------------------------------------------------------------
    # æœ¬åœ°ç¯å¢ƒé€šå¸¸èµ„æºæœ‰é™ï¼Œä½¿ç”¨è¾ƒå°çš„èµ„æºé…é¢
    replica_count: 1  # æœ¬åœ°åªéœ€è¦ 1 ä¸ªå‰¯æœ¬
    
    resources:
      requests:
        cpu: "50m"      # æœ¬åœ°ç¯å¢ƒé™ä½ CPU è¯·æ±‚
        memory: "64Mi"  # æœ¬åœ°ç¯å¢ƒé™ä½å†…å­˜è¯·æ±‚
      limits:
        cpu: "200m"     # æœ¬åœ°ç¯å¢ƒé™ä½ CPU é™åˆ¶
        memory: "256Mi" # æœ¬åœ°ç¯å¢ƒé™ä½å†…å­˜é™åˆ¶
    
    # -------------------------------------------------------------------------
    # è°ƒè¯•å’Œæ—¥å¿—é…ç½® | Debug and Logging Configuration
    # -------------------------------------------------------------------------
    log_level: "debug"  # æœ¬åœ°ç¯å¢ƒä½¿ç”¨ debug çº§åˆ«
    enable_metrics: true
    metrics_port: 2000
    
  # ===========================================================================
  # ä»»åŠ¡åˆ—è¡¨ | Tasks
  # ===========================================================================
  tasks:
    # -------------------------------------------------------------------------
    # 1. ç¯å¢ƒæ£€æµ‹å’ŒéªŒè¯ | Environment Detection and Validation
    # -------------------------------------------------------------------------
    - name: "ğŸ“‹ Display deployment information"
      ansible.builtin.debug:
        msg:
          - "==========================================â€‹=============================="
          - "ğŸš€ Cloudflare Tunnel - æœ¬åœ° Kubernetes éƒ¨ç½² (å¼€å‘ç¯å¢ƒ)"
          - "ğŸš€ Cloudflare Tunnel - Local Kubernetes Deployment (Development)"
          - "========================================â€‹================================"
          - "ğŸ“¦ éƒ¨ç½²æ¨¡å¼ | Mode: {{ deployment_mode }}"
          - "ğŸŒ ç¯å¢ƒ | Environment: {{ deployment_environment }}"
          - "ğŸ“ Namespace: {{ k8s_namespace }}"
          - "ğŸ“¦ Release Name: {{ helm_release_name }}"
          - "ğŸ”„ Replica Count: {{ replica_count }}"
          - "ğŸ“Š Resources: CPU {{ resources.requests.cpu }}-{{ resources.limits.cpu }}, Memory {{ resources.requests.memory }}-{{ resources.limits.memory }}"
          - "========================================â€‹================================"
      tags:
        - always

    - name: "ğŸ” Check Python interpreter"
      ansible.builtin.command: which python3
      register: python_check
      changed_when: false
      tags:
        - validation

    - name: "ğŸ Detect if running in virtualenv"
      ansible.builtin.set_fact:
        is_virtualenv: "{{ ansible_env.VIRTUAL_ENV is defined }}"
        virtualenv_path: "{{ ansible_env.VIRTUAL_ENV | default('Not in virtualenv') }}"
      tags:
        - validation

    - name: "â„¹ï¸  Display Python environment info"
      ansible.builtin.debug:
        msg:
          - "Python interpreter: {{ python_check.stdout }}"
          - "Virtual environment: {{ 'Yes' if is_virtualenv else 'No' }}"
          - "Virtualenv path: {{ virtualenv_path }}"
      tags:
        - validation

    - name: "ğŸ“¦ Check if kubernetes Python library is available"
      ansible.builtin.command: "{{ ansible_python_interpreter | default('python3') }} -c 'import kubernetes'"
      register: k8s_lib_check
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: "âš ï¸  Install Python dependencies if needed"
      ansible.builtin.pip:
        name:
          - kubernetes
          - openshift
          - pyyaml
        state: present
        executable: "{{ 'pip3' if not is_virtualenv else omit }}"
      when: k8s_lib_check.rc != 0
      tags:
        - validation

    - name: "âœ… Validate that cloudflare_tunnel_token is provided"
      ansible.builtin.assert:
        that:
          - cloudflare_tunnel_token is defined
          - cloudflare_tunnel_token != ""
          - cloudflare_tunnel_token | length > 20
        fail_msg: |
          âŒ Cloudflare Tunnel Token æœªæä¾›æˆ–æ— æ•ˆï¼
          âŒ Cloudflare Tunnel Token is not provided or invalid!
          
          è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€æä¾› Token:
          Please provide the token using one of the following methods:
          
          1. ç¯å¢ƒå˜é‡ | Environment variable:
             export CLOUDFLARE_TUNNEL_TOKEN="eyJhIjoiY2FmZS0xMjM0..."
          
          2. å‘½ä»¤è¡Œå‚æ•° | Command line parameter:
             ansible-playbook playbooks/cloudflared_k8s_local.yml \
               --extra-vars "cloudflare_tunnel_token=eyJhIjoiY2FmZS0xMjM0..."
          
          è·å– Token | Get Token:
          https://one.dash.cloudflare.com/ â†’ Access â†’ Tunnels
        success_msg: "âœ… cloudflare_tunnel_token is set and valid"
      tags:
        - validation

    - name: "ğŸ” Check if kubectl is installed"
      ansible.builtin.command: kubectl version --client --short
      register: kubectl_check
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: "âŒ Fail if kubectl is not installed"
      ansible.builtin.fail:
        msg: |
          âŒ kubectl is not installed or not in PATH.
          
          è¯·å®‰è£… kubectl | Please install kubectl:
          https://kubernetes.io/docs/tasks/tools/
      when: kubectl_check.rc != 0
      tags:
        - validation

    - name: "ğŸ” Check if Helm is installed"
      ansible.builtin.command: helm version --short
      register: helm_check
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: "âŒ Fail if Helm is not installed"
      ansible.builtin.fail:
        msg: |
          âŒ Helm is not installed. Please install Helm first.
          
          Installation instructions:
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_check.rc != 0
      tags:
        - validation

    - name: "ğŸ” Check local Kubernetes cluster connectivity"
      ansible.builtin.command: kubectl cluster-info
      register: cluster_info
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: "âŒ Fail if cannot connect to local Kubernetes cluster"
      ansible.builtin.fail:
        msg: |
          âŒ æ— æ³•è¿æ¥åˆ°æœ¬åœ° Kubernetes é›†ç¾¤ï¼
          âŒ Cannot connect to local Kubernetes cluster!
          
          è¯·ç¡®ä¿ä»¥ä¸‹ä¹‹ä¸€æ­£åœ¨è¿è¡Œ | Please ensure one of the following is running:
            - Minikube: minikube start
            - kind: kind create cluster
            - Docker Desktop: Enable Kubernetes in settings
            - K3s/K3d: k3d cluster create
            - MicroK8s: microk8s start
          
          ç„¶åæ£€æŸ¥ kubectl é…ç½® | Then check kubectl configuration:
            kubectl config get-contexts
            kubectl config use-context <your-context>
      when: cluster_info.rc != 0
      tags:
        - validation

    - name: "âœ… Display cluster information"
      ansible.builtin.debug:
        msg: "{{ cluster_info.stdout_lines }}"
      when: cluster_info.rc == 0
      tags:
        - validation

    - name: "ğŸ” Detect local Kubernetes environment type"
      ansible.builtin.shell: |
        if kubectl config current-context | grep -q minikube; then
          echo "minikube"
        elif kubectl config current-context | grep -q kind; then
          echo "kind"
        elif kubectl config current-context | grep -q docker-desktop; then
          echo "docker-desktop"
        elif kubectl config current-context | grep -q k3; then
          echo "k3s"
        elif kubectl config current-context | grep -q microk8s; then
          echo "microk8s"
        else
          echo "unknown"
        fi
      register: k8s_env_type
      changed_when: false
      tags:
        - validation

    - name: "â„¹ï¸  Display detected Kubernetes environment"
      ansible.builtin.debug:
        msg: "æ£€æµ‹åˆ°çš„æœ¬åœ° K8s ç¯å¢ƒ | Detected local K8s environment: {{ k8s_env_type.stdout }}"
      tags:
        - validation

    # -------------------------------------------------------------------------
    # 2. å‡†å¤‡ Kubernetes ç¯å¢ƒ | Prepare Kubernetes Environment
    # -------------------------------------------------------------------------
    - name: "ğŸ“¦ Ensure cloudflare-tunnel namespace exists"
      kubernetes.core.k8s:
        name: "{{ k8s_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      tags:
        - prepare

    - name: "ğŸ”‘ Create Kubernetes Secret for Tunnel Token"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflared-token
            namespace: "{{ k8s_namespace }}"
          type: Opaque
          stringData:
            token: "{{ cloudflare_tunnel_token }}"
      tags:
        - prepare
        - secret

    # -------------------------------------------------------------------------
    # 3. æ·»åŠ å’Œæ›´æ–° Helm Repository | Add and Update Helm Repository
    # -------------------------------------------------------------------------
    - name: "ğŸ“¦ Add Cloudflare Helm repository"
      kubernetes.core.helm_repository:
        name: cloudflare
        repo_url: "{{ helm_chart_repo }}"
        state: present
      tags:
        - helm

    - name: "ğŸ”„ Update Helm repositories"
      ansible.builtin.command: helm repo update
      changed_when: false
      tags:
        - helm

    # -------------------------------------------------------------------------
    # 4. éƒ¨ç½² Cloudflare Tunnel | Deploy Cloudflare Tunnel
    # -------------------------------------------------------------------------
    - name: "ğŸš€ Deploy Cloudflared using Helm"
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        chart_ref: "{{ helm_chart_name }}"
        chart_version: "{{ helm_chart_version if helm_chart_version else omit }}"
        release_namespace: "{{ k8s_namespace }}"
        create_namespace: false
        update_repo_cache: true
        values:
          # å‰¯æœ¬æ•°é‡
          replicaCount: "{{ replica_count }}"
          
          # é•œåƒé…ç½®
          image:
            repository: cloudflare/cloudflared
            pullPolicy: IfNotPresent
          
          # Tunnel Token é…ç½®
          cloudflare:
            tunnelToken: "{{ cloudflare_tunnel_token }}"
          
          # èµ„æºé™åˆ¶ï¼ˆæœ¬åœ°å¼€å‘ç¯å¢ƒï¼‰
          resources: "{{ resources }}"
          
          # æ—¥å¿—å’Œè°ƒè¯•
          extraArgs:
            - --loglevel
            - "{{ log_level }}"
            - --metrics
            - "0.0.0.0:{{ metrics_port }}"
          
          # Pod æ³¨è§£ï¼ˆç”¨äº Prometheus æŠ“å–æŒ‡æ ‡ï¼‰
          podAnnotations:
            prometheus.io/scrape: "{{ 'true' if enable_metrics else 'false' }}"
            prometheus.io/port: "{{ metrics_port }}"
            prometheus.io/path: "/metrics"
            deployment.mode: "{{ deployment_mode }}"
            deployment.environment: "{{ deployment_environment }}"
          
          # èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆæœ¬åœ°ç¯å¢ƒé€šå¸¸ä¸éœ€è¦ï¼‰
          nodeSelector: {}
          
          # å®¹å¿åº¦
          tolerations: []
          
          # äº²å’Œæ€§
          affinity: {}
      tags:
        - deploy

    # -------------------------------------------------------------------------
    # 5. éªŒè¯éƒ¨ç½² | Verify Deployment
    # -------------------------------------------------------------------------
    - name: "â³ Wait for Cloudflared pods to be ready"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=cloudflared"
      register: pod_list
      until: >
        pod_list.resources | length > 0 and
        pod_list.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == replica_count
      retries: 30
      delay: 10
      tags:
        - verify

    - name: "âœ… Get deployment status"
      ansible.builtin.command: kubectl get all -n {{ k8s_namespace }}
      register: deployment_status
      changed_when: false
      tags:
        - verify

    - name: "ğŸ“Š Display deployment status"
      ansible.builtin.debug:
        msg: "{{ deployment_status.stdout_lines }}"
      tags:
        - verify

    - name: "ğŸ“‹ Get pod logs (last 20 lines)"
      ansible.builtin.shell: |
        kubectl logs -n {{ k8s_namespace }} \
          -l app.kubernetes.io/name=cloudflared \
          --tail=20 \
          --all-containers=true
      register: pod_logs
      changed_when: false
      failed_when: false
      tags:
        - verify
        - logs

    - name: "ğŸ“ Display pod logs"
      ansible.builtin.debug:
        msg: "{{ pod_logs.stdout_lines }}"
      when: pod_logs.rc == 0
      tags:
        - verify
        - logs

    # -------------------------------------------------------------------------
    # 6. éƒ¨ç½²æˆåŠŸä¿¡æ¯ | Deployment Success Information
    # -------------------------------------------------------------------------
    - name: "ğŸ‰ Deployment completed successfully!"
      ansible.builtin.debug:
        msg:
          - "========================================â€‹================================"
          - "ğŸ‰ Cloudflare Tunnel éƒ¨ç½²æˆåŠŸï¼| Deployment Successful!"
          - "========================================â€‹================================"
          - ""
          - "ğŸ“¦ Namespace: {{ k8s_namespace }}"
          - "ğŸ“¦ Release: {{ helm_release_name }}"
          - "ğŸ”„ Replicas: {{ replica_count }}"
          - "ğŸŒ Environment: {{ deployment_environment }}"
          - ""
          - "å¸¸ç”¨å‘½ä»¤ | Common Commands:"
          - "  æŸ¥çœ‹çŠ¶æ€ | Check status:"
          - "    kubectl get all -n {{ k8s_namespace }}"
          - ""
          - "  æŸ¥çœ‹æ—¥å¿— | View logs:"
          - "    kubectl logs -n {{ k8s_namespace }} -l app.kubernetes.io/name=cloudflared -f"
          - ""
          - "  æŸ¥çœ‹è¯¦æƒ… | View details:"
          - "    kubectl describe deployment -n {{ k8s_namespace }} {{ helm_release_name }}"
          - ""
          - "  åˆ é™¤éƒ¨ç½² | Delete deployment:"
          - "    helm uninstall {{ helm_release_name }} -n {{ k8s_namespace }}"
          - ""
          - "  è®¿é—® Metrics | Access Metrics:"
          - "    kubectl port-forward -n {{ k8s_namespace }} deployment/{{ helm_release_name }} {{ metrics_port }}:{{ metrics_port }}"
          - "    ç„¶åè®¿é—® | Then visit: http://localhost:{{ metrics_port }}/metrics"
          - ""
          - "========================================â€‹================================"
      tags:
        - always
