---
# =============================================================================
# Cloudflare Tunnel Kubernetes Deployment (Helm-based)
# =============================================================================
# æ­¤ Playbook ä½¿ç”¨ Helm Chart åœ¨ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½² Cloudflare Tunnel
# This Playbook deploys Cloudflare Tunnel on Kubernetes cluster using Helm Chart
# =============================================================================
#
# ðŸ”’ å®‰å…¨è­¦å‘Š | Security Warning:
#   æ­¤ Playbook ä¸åŒ…å«ä»»ä½•ç§˜å¯†ä¿¡æ¯ï¼
#   This Playbook contains NO secrets!
#
# ðŸ“– ä½¿ç”¨æ–¹æ³• | Usage:
#
#   æ–¹æ³• 1: ä½¿ç”¨å‘½ä»¤è¡Œä¼ é€’å˜é‡ | Pass variables via command line:
#     ansible-playbook playbooks/cloudflared_k8s_helm.yml \
#       --extra-vars "cloudflare_tunnel_token=eyJhIjoiY2FmZS0xMjM0..."
#
#   æ–¹æ³• 2: ä½¿ç”¨ Ansible Vault | Use Ansible Vault:
#     # åˆ›å»ºåŠ å¯†çš„å˜é‡æ–‡ä»¶ | Create encrypted vars file:
#     ansible-vault create vars/cloudflare_secrets.yml
#     # åœ¨æ–‡ä»¶ä¸­æ·»åŠ : cloudflare_tunnel_token: "your-token-here"
#
#     # è¿è¡Œ playbook | Run playbook:
#     ansible-playbook playbooks/cloudflared_k8s_helm.yml \
#       --vault-password-file ~/.vault_pass
#
#   æ–¹æ³• 3: ä½¿ç”¨çŽ¯å¢ƒå˜é‡ | Use environment variable:
#     export CLOUDFLARE_TUNNEL_TOKEN="eyJhIjoiY2FmZS0xMjM0..."
#     ansible-playbook playbooks/cloudflared_k8s_helm.yml
#
#   æ–¹æ³• 4: CI/CD (GitHub Actions):
#     - GitHub Workflow ä¼šè‡ªåŠ¨ä»Ž secrets.CLOUDFLARE_TUNNEL_TOKEN è¯»å–
#     - GitHub Workflow will automatically read from secrets.CLOUDFLARE_TUNNEL_TOKEN
#
# =============================================================================

- name: Deploy Cloudflare Tunnel on Kubernetes using Helm
  hosts: localhost
  connection: local
  gather_facts: no
  
  environment:
    # ç¡®ä¿ä½¿ç”¨ç³»ç»Ÿçš„ helm è€Œä¸æ˜¯ Python è™šæ‹ŸçŽ¯å¢ƒä¸­çš„
    PATH: "/usr/local/bin:/usr/bin:/bin:{{ ansible_env.PATH }}"
  
  vars:
    # -------------------------------------------------------------------------
    # Cloudflare Tunnel é…ç½® | Cloudflare Tunnel Configuration
    # -------------------------------------------------------------------------
    # Token ä¼˜å…ˆçº§ | Token Priority:
    #   1. --extra-vars å‘½ä»¤è¡Œå‚æ•° | Command line --extra-vars
    #   2. Ansible Vault åŠ å¯†æ–‡ä»¶ | Ansible Vault encrypted file
    #   3. çŽ¯å¢ƒå˜é‡ CLOUDFLARE_TUNNEL_TOKEN | Environment variable
    # -------------------------------------------------------------------------
    cloudflare_tunnel_token: "{{ lookup('env', 'CLOUDFLARE_TUNNEL_TOKEN') | default('') }}"
    
    # -------------------------------------------------------------------------
    # Kubernetes é…ç½® | Kubernetes Configuration
    # -------------------------------------------------------------------------
    k8s_namespace: "cloudflare-tunnel"
    k8s_release_name: "cloudflared"
    
    # -------------------------------------------------------------------------
    # Helm é…ç½® | Helm Configuration
    # -------------------------------------------------------------------------
    helm_repo_name: "cloudflare"
    helm_repo_url: "https://cloudflare.github.io/helm-charts"
    helm_chart_name: "cloudflare/cloudflared"
    helm_chart_version: ""  # ç•™ç©ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ | Empty for latest version
    
    # -------------------------------------------------------------------------
    # é«˜å¯ç”¨æ€§é…ç½® | High Availability Configuration
    # -------------------------------------------------------------------------
    replica_count: 2  # æŽ¨èè‡³å°‘ 2 ä¸ªå‰¯æœ¬ | Recommend at least 2 replicas
    
    # -------------------------------------------------------------------------
    # èµ„æºé…ç½® | Resource Configuration
    # -------------------------------------------------------------------------
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"

  tasks:
    # -------------------------------------------------------------------------
    # å‰ç½®æ£€æŸ¥ | Pre-flight Checks
    # -------------------------------------------------------------------------
    
    - name: Check Python interpreter
      ansible.builtin.set_fact:
        ansible_python_interpreter: "{{ ansible_playbook_python }}"
      tags:
        - always

    - name: Detect if running in virtualenv
      ansible.builtin.stat:
        path: "{{ ansible_env.VIRTUAL_ENV | default('/nonexistent') }}/bin/python"
      register: venv_python
      tags:
        - always

    - name: Check if kubernetes Python library is available
      ansible.builtin.command: "{{ ansible_python_interpreter }} -c 'import kubernetes'"
      register: k8s_lib_check
      changed_when: false
      failed_when: false
      tags:
        - always

    - name: Install Python dependencies if needed
      ansible.builtin.pip:
        name:
          - kubernetes
          - openshift
          - PyYAML
        state: present
        executable: "{{ (ansible_env.VIRTUAL_ENV + '/bin/pip') if ansible_env.VIRTUAL_ENV is defined else 'pip3' }}"
      when: k8s_lib_check.rc != 0
      tags:
        - always

    - name: Validate that cloudflare_tunnel_token is provided
      ansible.builtin.assert:
        that:
          - cloudflare_tunnel_token is defined
          - cloudflare_tunnel_token | length > 0
          - cloudflare_tunnel_token != ''
        fail_msg: |
          âŒ FATAL ERROR: cloudflare_tunnel_token is not set!

          You MUST provide the Cloudflare Tunnel Token via one of these methods:

          ðŸ“– Method 1 - Command Line:
            ansible-playbook playbooks/cloudflared_k8s_helm.yml \
              --extra-vars "cloudflare_tunnel_token=eyJhIjoiY2FmZS0xMjM0..."

          ðŸ“– Method 2 - Ansible Vault:
            ansible-vault create vars/cloudflare_secrets.yml
            # Add: cloudflare_tunnel_token: "your-token"
            ansible-playbook playbooks/cloudflared_k8s_helm.yml --vault-password-file ~/.vault_pass

          ðŸ“– Method 3 - Environment Variable:
            export CLOUDFLARE_TUNNEL_TOKEN="eyJhIjoiY2FmZS0xMjM0..."
            ansible-playbook playbooks/cloudflared_k8s_helm.yml

          ðŸ“š Docs: https://github.com/AnixOps/AnixOps-ansible/docs/SECRETS_MANAGEMENT.md
        success_msg: "âœ… cloudflare_tunnel_token is set and valid"
      tags:
        - validation

    - name: Check if kubectl is installed
      ansible.builtin.command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: Fail if kubectl is not installed
      ansible.builtin.fail:
        msg: "âŒ kubectl is not installed. Please install kubectl first."
      when: kubectl_check.rc != 0
      tags:
        - validation

    - name: Check if Helm is installed
      ansible.builtin.command: helm version
      register: helm_check
      changed_when: false
      failed_when: false
      tags:
        - validation

    - name: Fail if Helm is not installed
      ansible.builtin.fail:
        msg: |
          âŒ Helm is not installed. Please install Helm first.
          
          Installation instructions:
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_check.rc != 0
      tags:
        - validation

    - name: Print deployment info (token is masked)
      ansible.builtin.debug:
        msg:
          - "ðŸš€ Starting Cloudflare Tunnel deployment on Kubernetes"
          - "ðŸ“¦ Namespace: {{ k8s_namespace }}"
          - "ðŸ“¦ Release Name: {{ k8s_release_name }}"
          - "ðŸ” Token status: âœ… Provided (first 10 chars: {{ cloudflare_tunnel_token[:10] }}...)"
          - "ðŸ”„ Replica Count: {{ replica_count }}"
          - "ðŸ“Š Resources: CPU {{ resources.requests.cpu }}-{{ resources.limits.cpu }}, Memory {{ resources.requests.memory }}-{{ resources.limits.memory }}"
      tags:
        - cloudflared

    # -------------------------------------------------------------------------
    # å‘½åç©ºé—´ç®¡ç† | Namespace Management
    # -------------------------------------------------------------------------

    - name: Ensure cloudflare-tunnel namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ k8s_namespace }}"
            labels:
              name: "{{ k8s_namespace }}"
              managed-by: ansible
              component: cloudflare-tunnel
      tags:
        - namespace
        - cloudflared

    # -------------------------------------------------------------------------
    # Helm ä»“åº“ç®¡ç† | Helm Repository Management
    # -------------------------------------------------------------------------

    - name: Add Cloudflare Helm repository
      kubernetes.core.helm_repository:
        name: "{{ helm_repo_name }}"
        repo_url: "{{ helm_repo_url }}"
      tags:
        - helm
        - cloudflared

    - name: Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false
      tags:
        - helm
        - cloudflared

    # -------------------------------------------------------------------------
    # ä½¿ç”¨ Helm éƒ¨ç½² Cloudflared | Deploy Cloudflared using Helm
    # -------------------------------------------------------------------------

    - name: Deploy cloudflared using Helm Chart
      kubernetes.core.helm:
        name: "{{ k8s_release_name }}"
        chart_ref: "{{ helm_chart_name }}"
        chart_version: "{{ helm_chart_version if helm_chart_version else omit }}"
        release_namespace: "{{ k8s_namespace }}"
        create_namespace: false  # å·²ç»åˆ›å»º | Already created
        update_repo_cache: true
        wait: true
        wait_timeout: "5m"
        values:
          # Cloudflare Tunnel Token (ä¸ä¼šè¢«è®°å½•åˆ°æ—¥å¿—) | Token (not logged)
          cloudflare:
            token: "{{ cloudflare_tunnel_token }}"
          
          # é«˜å¯ç”¨æ€§é…ç½® | High Availability Configuration
          replicaCount: "{{ replica_count }}"
          
          # èµ„æºé…ç½® | Resource Configuration
          resources: "{{ resources }}"
          
          # Pod åäº²å’Œæ€§ (ç¡®ä¿å‰¯æœ¬åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹) | Pod Anti-Affinity
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: app.kubernetes.io/name
                          operator: In
                          values:
                            - cloudflared
                    topologyKey: kubernetes.io/hostname
          
          # è‡ªåŠ¨é‡å¯ç­–ç•¥ | Auto-restart Policy
          restartPolicy: Always
          
          # é•œåƒé…ç½® | Image Configuration
          image:
            repository: cloudflare/cloudflared
            pullPolicy: IfNotPresent
          
          # æ—¥å¿—é…ç½® | Logging Configuration
          logLevel: info
          
          # å¥åº·æ£€æŸ¥ | Health Checks
          livenessProbe:
            enabled: true
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            enabled: true
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          # Pod æ ‡ç­¾ | Pod Labels
          podLabels:
            app: cloudflared
            managed-by: ansible
            component: cloudflare-tunnel
          
          # Pod æ³¨è§£ | Pod Annotations
          podAnnotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "2000"
            prometheus.io/path: "/metrics"
      register: helm_deploy_result
      tags:
        - helm
        - cloudflared
        - deploy

    # -------------------------------------------------------------------------
    # éƒ¨ç½²éªŒè¯ | Deployment Verification
    # -------------------------------------------------------------------------

    - name: Wait for cloudflared pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=cloudflared
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
      register: pod_info
      tags:
        - verification
        - cloudflared

    - name: Display deployment status
      ansible.builtin.debug:
        msg:
          - "âœ… Cloudflare Tunnel deployed successfully!"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ðŸ“¦ Namespace: {{ k8s_namespace }}"
          - "ðŸš€ Release: {{ k8s_release_name }}"
          - "ðŸ”„ Replicas: {{ replica_count }}"
          - "ðŸ“Š Ready Pods: {{ pod_info.resources | length }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ðŸ” Verify deployment:"
          - "   kubectl get pods -n {{ k8s_namespace }}"
          - "   kubectl logs -n {{ k8s_namespace }} -l app.kubernetes.io/name=cloudflared"
          - ""
          - "ðŸ—‘ï¸  Uninstall:"
          - "   helm uninstall {{ k8s_release_name }} -n {{ k8s_namespace }}"
      tags:
        - verification
        - cloudflared

    - name: Get pod details
      ansible.builtin.command: >
        kubectl get pods -n {{ k8s_namespace }} -o wide
      register: pod_details
      changed_when: false
      tags:
        - verification
        - cloudflared

    - name: Show pod details
      ansible.builtin.debug:
        msg: "{{ pod_details.stdout_lines }}"
      tags:
        - verification
        - cloudflared
