---
# Cloudflare Tunnel Deployment Workflow
# This workflow demonstrates how to securely deploy Cloudflare Tunnel using GitHub Secrets

name: Deploy Cloudflare Tunnel

# è§¦å‘æ¡ä»¶ | Trigger conditions
on:
  # æ‰‹åŠ¨è§¦å‘ | Manual trigger
  workflow_dispatch:
    inputs:
      target_hosts:
        description: 'Target hosts (leave empty for all)'
        required: false
        default: 'all'
        type: string
      
      dry_run:
        description: 'Dry run mode (check only, no changes)'
        required: false
        default: false
        type: boolean

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ (å¯é€‰) | Trigger on push to main (optional)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'roles/anix_cloudflared/**'
  #     - 'playbooks/cloudflared_playbook.yml'

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªéƒ¨ç½² | Concurrency control: only one deployment at a time
concurrency:
  group: cloudflared-deployment
  cancel-in-progress: false

jobs:
  deploy-cloudflare-tunnel:
    name: Deploy Cloudflare Tunnel
    runs-on: ubuntu-latest
    
    # ç¯å¢ƒé…ç½® (å¯é€‰) | Environment configuration (optional)
    # environment: production
    
    steps:
      # -----------------------------------------------------------------------
      # 1. æ£€å‡ºä»£ç  | Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -----------------------------------------------------------------------
      # 2. è®¾ç½® Python ç¯å¢ƒ | Setup Python environment
      # -----------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # -----------------------------------------------------------------------
      # 3. å®‰è£… Ansible å’Œä¾èµ– | Install Ansible and dependencies
      # -----------------------------------------------------------------------
      - name: Install Ansible dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # 4. éªŒè¯ Ansible é…ç½® | Verify Ansible configuration
      # -----------------------------------------------------------------------
      - name: Verify Ansible setup
        run: |
          ansible --version
          ansible-lint --version

      # -----------------------------------------------------------------------
      # 5. Lint Ansible ä»£ç  | Lint Ansible code
      # -----------------------------------------------------------------------
      - name: Run Ansible Lint
        run: |
          ansible-lint roles/anix_cloudflared/
          ansible-lint playbooks/cloudflared_playbook.yml

      # -----------------------------------------------------------------------
      # 6. é…ç½® SSH å¯†é’¥ | Configure SSH key
      # -----------------------------------------------------------------------
      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ·»åŠ ç›®æ ‡ä¸»æœºåˆ° known_hosts (ç¦ç”¨ä¸¥æ ¼ä¸»æœºæ£€æŸ¥) 
          # Add target hosts to known_hosts (disable strict host checking)
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      # -----------------------------------------------------------------------
      # 7. æµ‹è¯• Ansible è¿æ¥ | Test Ansible connectivity
      # -----------------------------------------------------------------------
      - name: Test Ansible connectivity
        run: |
          ansible ${{ inputs.target_hosts || 'all' }} -m ping

      # -----------------------------------------------------------------------
      # 8. è¿è¡Œ Playbook (Dry Run æ¨¡å¼) | Run Playbook (Dry Run mode)
      # -----------------------------------------------------------------------
      - name: Ansible Dry Run (Check Mode)
        if: ${{ inputs.dry_run == true }}
        env:
          # ğŸ” å…³é”®æ­¥éª¤ï¼šä» GitHub Secrets è¯»å– Token å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
          # ğŸ” Key step: Read Token from GitHub Secrets and set as environment variable
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          ansible-playbook playbooks/cloudflared_playbook.yml \
            --limit "${{ inputs.target_hosts || 'all' }}" \
            --check \
            --diff \
            --verbose

      # -----------------------------------------------------------------------
      # 9. è¿è¡Œ Playbook (å®é™…éƒ¨ç½²) | Run Playbook (Actual deployment)
      # -----------------------------------------------------------------------
      - name: Deploy Cloudflare Tunnel
        if: ${{ inputs.dry_run != true }}
        env:
          # ğŸ” å…³é”®æ­¥éª¤ï¼šä» GitHub Secrets è¯»å– Token å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
          # ğŸ” Key step: Read Token from GitHub Secrets and set as environment variable
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          ansible-playbook playbooks/cloudflared_playbook.yml \
            --limit "${{ inputs.target_hosts || 'all' }}" \
            --verbose

      # -----------------------------------------------------------------------
      # 10. éªŒè¯éƒ¨ç½² | Verify deployment
      # -----------------------------------------------------------------------
      - name: Verify Cloudflare Tunnel service
        if: ${{ inputs.dry_run != true }}
        run: |
          ansible ${{ inputs.target_hosts || 'all' }} \
            -m shell \
            -a "systemctl status cloudflared --no-pager"

      # -----------------------------------------------------------------------
      # 11. éƒ¨ç½²æˆåŠŸé€šçŸ¥ | Deployment success notification
      # -----------------------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Cloudflare Tunnel Deployment Successful               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ¯ Target: ${{ inputs.target_hosts || 'all' }}"
          echo "ğŸ·ï¸  Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # -----------------------------------------------------------------------
      # 12. æ¸…ç†æ•æ„Ÿæ–‡ä»¶ | Clean up sensitive files
      # -----------------------------------------------------------------------
      - name: Clean up SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/config
