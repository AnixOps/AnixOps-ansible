---
# Ansible Inventory - Smart IP Connection
# Server IPs are read from environment variables (.env file)
# 
# 连接逻辑：
# - /31 (IPv4) 或 /127 (IPv6) 段：直接连接该IP
# - 其他网段：使用 _SSH_IP 变量指定的连接IP
#
# Copy .env.example to .env and fill in your server IPs

all:
  children:
    # ========================================
    # 美国西部服务器
    # ========================================
    us_west_servers:
      hosts:
        # 点对点连接 (/31段)，直接使用该IP
        us-w-1:
          ansible_host: "{{ lookup('env', 'US_W_1_V4') | regex_replace('/.*', '') }}"
          ipv6_address: "{{ lookup('env', 'US_W_1_V6') | regex_replace('/.*', '') }}"
          cidr_mask: "{{ lookup('env', 'US_W_1_V4') | regex_search('/.*') }}"
        
        # 其他网段 (/24)，需要使用SSH_IP连接
        us-w-2:
          # 内网IP（用于配置管理）
          ansible_host: "{{ lookup('env', 'US_W_2_V4') | regex_replace('/.*', '') }}"
          ipv6_address: "{{ lookup('env', 'US_W_2_V6') | regex_replace('/.*', '') }}"
          cidr_mask: "{{ lookup('env', 'US_W_2_V4') | regex_search('/.*') }}"
          # SSH连接IP（公网IP或网关）
          ssh_connection_ip: "{{ lookup('env', 'US_W_2_SSH_IP') }}"
          # 如果设置了SSH_IP，则通过该IP连接
          ansible_host: "{{ lookup('env', 'US_W_2_SSH_IP') if lookup('env', 'US_W_2_SSH_IP') else lookup('env', 'US_W_2_V4') | regex_replace('/.*', '') }}"
      vars:
        region: us-west
        
    # ========================================
    # 美国东部服务器
    # ========================================
    us_east_servers:
      hosts:
        us-e-1:
          ansible_host: "{{ lookup('env', 'US_E_1_V4') | regex_replace('/.*', '') }}"
          ipv6_address: "{{ lookup('env', 'US_E_1_V6') | regex_replace('/.*', '') }}"
      vars:
        region: us-east
        
    # ========================================
    # 日本服务器（内网段示例）
    # ========================================
    japan_servers:
      hosts:
        jp-1:
          # 内网IP
          internal_ip: "{{ lookup('env', 'JP_1_V4') | regex_replace('/.*', '') }}"
          ipv6_address: "{{ lookup('env', 'JP_1_V6') | regex_replace('/.*', '') }}"
          # SSH连接使用公网IP
          ansible_host: "{{ lookup('env', 'JP_1_SSH_IP') if lookup('env', 'JP_1_SSH_IP') else lookup('env', 'JP_1_V4') | regex_replace('/.*', '') }}"
      vars:
        region: japan
        
    # ========================================
    # 欧洲服务器
    # ========================================
    europe_servers:
      hosts:
        eu-1:
          ansible_host: "{{ lookup('env', 'EU_1_V4') | regex_replace('/.*', '') }}"
          ipv6_address: "{{ lookup('env', 'EU_1_V6') | regex_replace('/.*', '') }}"
      vars:
        region: europe

    # ========================================
    # 功能分组 (Web/App/DB)
    # ========================================
    web_servers:
      hosts:
        us-w-1:
        us-e-1:
      vars:
        server_role: web
        
    app_servers:
      hosts:
        us-w-2:
        jp-1:
      vars:
        server_role: app
        
    db_servers:
      hosts:
        eu-1:
      vars:
        server_role: database

  # ========================================
  # 全局变量 - 所有服务器共享
  # ========================================
  vars:
    # SSH 连接配置
    ansible_user: "{{ lookup('env', 'ANSIBLE_USER') | default('root') }}"
    ansible_port: "{{ lookup('env', 'ANSIBLE_PORT') | default('22') }}"
    ansible_ssh_private_key_file: "{{ lookup('env', 'SSH_KEY_PATH') | default('~/.ssh/id_rsa') }}"
    
    # Python 解释器
    ansible_python_interpreter: /usr/bin/python3
    
    # SSH 参数
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
